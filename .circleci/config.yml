version: 2
jobs:
   build:
     working_directory: ~/thrive
     docker:
       - image: hhyyrylainen/godot-ci:v1
     environment:
       GIT_LFS_SKIP_SMUDGE: 1
     steps:
       - checkout
       - restore_cache:
           keys:
             - v3-lfs-{{ .Branch }}
             - v3-lfs-master
       - shell:
           name: Pull Git LFS files, retry until done
           command: |
             while true; do git reset --hard HEAD && git clean -fd && git lfs pull && break; done
       - save_cache:
          key: v3-lfs-{{ .Branch }}
          paths:
            - .git/lfs
       - restore_cache:
           keys:
             - v1-import-{{ .Branch }}
             - v1-import-master
       - run: ./headless_project_refresh.rb
       - restore_cache:
           keys:
             - v1-nuget-{{ .Branch }}
       - nuget restore
       - save_cache:
          key: - v1-nuget-{{ .Branch }}
          paths:
            - ~/.nuget/packages
       - run: godot --export "linux_x11_64_release" "builds/thrive_linux.zip"
       - save_cache:
           key: v1-import-{{ .Branch }}
           paths:
             - .import
   format_script:
     working_directory: ~/Thrive
     docker:
       - image: hhyyrylainen/godot-ci:v1
     environment:
       GIT_LFS_SKIP_SMUDGE: 1
     steps:
       - checkout
       - run: ./headless_project_refresh.rb
       - restore_cache:
           keys:
             - v1-nuget-{{ .Branch }}
       - nuget restore
       - save_cache:
          key: - v1-nuget-{{ .Branch }}
          paths:
            - ~/.nuget/packages
       - run: ./check_formatting.rb

workflows:
  version: 2
  build_and_format:
    jobs:
      - build
      - format_script
